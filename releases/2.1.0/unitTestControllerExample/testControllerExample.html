<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>IQB TestController Simulation</title>
    
    <script>
    var availableResource = {};
    </script>
    
    <link rel="stylesheet" href="includes/jquery-ui-1.12.1.custom/jquery-ui.css">
    <script src="includes/jquery-3.3.1.min.js"></script>
    <script src="includes/jquery-ui-1.12.1.custom/jquery-ui.js"></script>
</head>
<body>
<!-- 
    Example messages to the unit player iframe:

    Page navigation:

    document.getElementById('unitIFrame').contentWindow.postMessage({type: 'vo.ToPlayer.PageNavigationRequest', sessionId: 'test session id', newPage: 'seite1'},'*');
    
-->
    <p style="text-align:center">
        <button id="btnLoadUnit">Load unit</button>
        <button id="btnEnterRestorePoint">Enter restore point manually</button>
        <button id="btnUnloadUnit">Unload unit</button>
        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
        <button id="btnLoadRestorePoint">Load unit and use restore point from localStorage</button>
        <button id="btnSaveRestorePoint">Save current unit status into a restore point in localStorage</button>
        <br /><br />
        <iframe style="height: 700px; width: 100%;" id="unitIFrame" src="about:blank"></iframe>
        <hr />
        <div id="pageNavigator" style="width: 100%; text-align: center;"></div>
        <script>

            var currentRestorePoint = "";
            var uploadedUnitDefinition = "";
            var useRestorePoint = false;


            function initializeIFrame()
            {
                console.log('initializing iframe...');
                document.getElementById("unitIFrame").src = "includes/unitPlayer.html";
            }

            function initializeUnitPlayer()
            {
                console.log('Initializing unit player...');
                let restorePointToLoad = "";
                if (useRestorePoint) restorePointToLoad = currentRestorePoint;

                document.getElementById("unitIFrame").contentWindow.postMessage({
                                                                                type: "vo.ToPlayer.DataTransfer",
                                                                                unitDefinition: uploadedUnitDefinition,
                                                                                resources: {},
                                                                                restorePoint: restorePointToLoad,
                                                                                sessionId: "test session id"
                                                                            }, "*");
            }

            function loadUnit()
            {
                jQuery( "#fileDialog" ).dialog({
                            width: 600,
                            height: 200,
                            dialogClass: "",
                            title: "Load Unit",
                            buttons: [
                            {
                                text: "OK",
                                click: function() {
                                jQuery(this).dialog( "close" );
                                let uploadedFiles = document.getElementById('inputFile').files;
                                if (uploadedFiles !== null)
                                    if (uploadedFiles.length > 0)
                                    {
                                        let uploadedFile = uploadedFiles[0];
                                        let myReader = new FileReader();
                                        myReader.onload =  (e) => {
                                            let uploadedFileContent = e.target.result;
                                            uploadedUnitDefinition = uploadedFileContent;
                                            // console.log(uploadedUnitDefinition);

                                            if (useRestorePoint === false) currentRestorePoint = "";
                                            initializeIFrame();
                                        }
                                        myReader.readAsText(uploadedFile);
                                    }
                    
                                }
                    
                            }
                            ]
                        });    
            }

            document.getElementById("btnLoadUnit").addEventListener("click", function(e)
            {
                useRestorePoint = false;
                loadUnit();
            });

            document.getElementById("btnUnloadUnit").addEventListener("click", function(e)
            {
                document.getElementById("unitIFrame").src= "about:blank";
            });

            // restore point functionality
            document.getElementById("btnSaveRestorePoint").addEventListener("click", (e) =>
            {
                // console.log("Saving restore point: ");
                // console.log(currentRestorePoint);
                localStorage.setItem("restorePoint", currentRestorePoint);
            });

            document.getElementById("btnLoadRestorePoint").addEventListener("click", (e) =>
            {
                if (localStorage.getItem("restorePoint") != null )
                {
                    useRestorePoint = true;
                    // console.log("Loading restore point:");
                    // console.log(localStorage.getItem("restorePoint"));
                    currentRestorePoint = localStorage.getItem("restorePoint");
                    loadUnit();
                } 
                else alert("Restore point not found in localStorage.");
            });

            document.getElementById("btnEnterRestorePoint").addEventListener("click", (e) =>
            {
                if (uploadedUnitDefinition !== '') {
                    useRestorePoint = true;
                    currentRestorePoint = prompt('Restore point:');
                    initializeIFrame();
                }
                else {
                    alert('no unit currently loaded.');
                }
            });

            window.addEventListener("message", (messageEvent) => {
                // console.log("TestController has received a message:");
                // console.log(messageEvent);

                if (messageEvent.data.type === "vo.FromPlayer.ChangedDataTransfer")
                {
                    if ('restorePoint' in messageEvent.data)
                    {
                        currentRestorePoint = messageEvent.data.restorePoint;
                    }
                }
                else if (messageEvent.data.type === 'vo.FromPlayer.StartedNotification')
                {
                    if ('validPages' in messageEvent.data) {
                        // if the unit send a list of pages, implement page navigation
                        const pageNavigatorDiv = document.getElementById('pageNavigator');
                        pageNavigatorDiv.innerHTML = '';

                        const validPages = messageEvent.data.validPages;
                        let pageNavigatorHTML = '';
                        validPages.forEach((validPage) => {
                            pageNavigatorDiv.insertAdjacentHTML('beforeend', 
                                                                `<span class="navigateToPage">${validPage}</span> | `);
                        });

                        document.querySelectorAll('.navigateToPage').forEach ((element) => {
                            const pageName = element.innerHTML;
                            element.style.cursor = 'pointer';
                            element.onclick = () => {

                                document.querySelectorAll('.navigateToPage').forEach ((elementIterator) => { 
                                    // all pages should be displayed normally
                                    elementIterator.style.fontWeight = 'normal';
                                });
                                element.style.fontWeight = 'bold'; // except selected page, which is bold

                                document.getElementById("unitIFrame").contentWindow.postMessage({
                                                                                                type: "vo.ToPlayer.NavigateToPage",
                                                                                                sessionId: "test session id",
                                                                                                newPage: pageName
                                                                                            }, "*");
                                            };
                        });
                    }
                }
                else if (messageEvent.data.type === 'vo.FromPlayer.ReadyNotification')
                {
                    initializeUnitPlayer();
                }
            })
            // end of restore point functionality
        </script>
    </p>

    <div id="fileDialog" style="display:none; text-align: center; vertical-align: middle;">
        <input type="file" id="inputFile" name="inputFile" style="margin-top: 12px">
    </div>
</body>
</html>