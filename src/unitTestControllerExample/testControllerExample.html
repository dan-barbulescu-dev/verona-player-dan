<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>IQB TestController Simulation</title>
    
    <script>
    var availableResource = {};
    </script>
    
    <link rel="stylesheet" href="includes/jquery-ui-1.12.1.custom/jquery-ui.css">
    <script src="includes/jquery-3.3.1.min.js"></script>
    <script src="includes/jquery-ui-1.12.1.custom/jquery-ui.js"></script>
</head>
<body>
<!-- 
    Example messages to the item player iframe:

    Page navigation:

    document.getElementById('unitIFrame').contentWindow.postMessage({type: 'OpenCBA.ToItemPlayer.PageNavigationRequest', sessionId: 'test session id', newPage: 'seite1'},'*');


    
-->
    <p style="text-align:center">
        <button id="btnLoadItem">Load Item</button>
        <button id="btnLoadRestorePoint">Load item and use restore point from localStorage</button>
        <button id="btnUnloadItem">Unload Item</button>
        <button id="btnSaveRestorePoint">Save current item status into a restore point in localStorage</button>
        <br /><br />
        <iframe style="height: 800px; width: 1200px;" id="unitIFrame" src="about:blank"></iframe>
        <script>

            var currentRestorePoint = "";
            var uploadedItemSpecification = "";
            var useRestorePoint = false;


            function initializeIFrame()
            {
                console.log('initializing iframe...');
                document.getElementById("unitIFrame").src = "unitPlayer.html";
            }

            function initializeItemPlayer()
            {
                console.log('Initializing item player...');
                let restorePointToLoad = "";
                if (useRestorePoint) restorePointToLoad = currentRestorePoint;

                document.getElementById("unitIFrame").contentWindow.postMessage({
                                                                                type: "OpenCBA.ToItemPlayer.DataTransfer",
                                                                                unitDefinition: uploadedItemSpecification,
                                                                                resources: {},
                                                                                restorePoint: restorePointToLoad,
                                                                                sessionId: "test session id"
                                                                            }, "*");
            }

            function loadItem()
            {
                jQuery( "#fileDialog" ).dialog({
                            width: 600,
                            height: 200,
                            dialogClass: "",
                            title: "Open item",
                            buttons: [
                            {
                                text: "OK",
                                click: function() {
                                jQuery(this).dialog( "close" );
                                let uploadedFiles = document.getElementById('inputFile').files;
                                if (uploadedFiles !== null)
                                    if (uploadedFiles.length > 0)
                                    {
                                        let uploadedFile = uploadedFiles[0];
                                        let myReader = new FileReader();
                                        myReader.onload =  (e) => {
                                            let uploadedFileContent = e.target.result;
                                            uploadedItemSpecification = uploadedFileContent;
                                            // console.log(uploadedItemSpecification);

                                            if (useRestorePoint === false) currentRestorePoint = "";
                                            initializeIFrame();
                                        }
                                        myReader.readAsText(uploadedFile);
                                    }
                    
                                }
                    
                            }
                            ]
                        });    
            }

            document.getElementById("btnLoadItem").addEventListener("click", function(e)
            {
                useRestorePoint = false;
                loadItem();
            });

            document.getElementById("btnUnloadItem").addEventListener("click", function(e)
            {
                document.getElementById("unitIFrame").src= "about:blank";
            });

            // restore point functionality
            document.getElementById("btnSaveRestorePoint").addEventListener("click", (e) =>
            {
                console.log("Saving restore point: ");
                console.log(currentRestorePoint);
                localStorage.setItem("restorePoint", currentRestorePoint);
            });

            document.getElementById("btnLoadRestorePoint").addEventListener("click", (e) =>
            {
                if (localStorage.getItem("restorePoint") != null )
                {
                    useRestorePoint = true;
                    console.log("Loading restore point:");
                    console.log(localStorage.getItem("restorePoint"));
                    currentRestorePoint = localStorage.getItem("restorePoint");
                    loadItem();
                } 
                else alert("Restore point not found in localStorage.");

            });

            window.addEventListener("message", (messageEvent) => {
                console.log("TestController has received a message:");
                console.log(messageEvent);

                
                if (messageEvent.data.type === "OpenCBA.FromItemPlayer.ChangedDataTransfer")
                {
                    if ('restorePoint' in messageEvent.data)
                    {
                        currentRestorePoint = messageEvent.data.restorePoint;
                    }
                }
                else if (messageEvent.data.type === 'OpenCBA.FromItemPlayer.ReadyNotification')
                {
                    initializeItemPlayer();
                }
            })
            // end of restore point functionality
        </script>
    </p>

    <div id="fileDialog" style="display:none; text-align: center; vertical-align: middle;">
        <input type="file" id="inputFile" name="inputFile" style="margin-top: 12px">
    </div>
</body>
</html>